# credit: https://stackoverflow.com/a/21028226/13933174
# the commit's SHA1, and whether the building workspace was dirty or not
# defines RPI_Version library which should be compiled into main

# generate version.cpp (into binary dir)
set(VERSION_AUTOGEN_DIR "${CMAKE_CURRENT_BINARY_DIR}") # save in build dir so dont have to gitignore
set(VERSION_SRC_PATH "${CMAKE_CURRENT_SOURCE_DIR}/version.cpp.in")
set(VERSION_DST_PATH "${VERSION_AUTOGEN_DIR}/version.cpp")

add_library(RPI_Version
    ${VERSION_DST_PATH} # autogenerated from version.cpp.in
)

# include created libs from other dirs -- comes after add executable
target_link_libraries(RPI_Version
)

target_compile_options(RPI_Version
    PRIVATE
)

set_target_properties(RPI_Version
    PROPERTIES LINKER_LANGUAGE CXX
)


# make sure this library is rebuilt everytime (and thus version is updated each build, even if no changes)
# https://stackoverflow.com/a/35302833/13933174

# make RPI_Version depend on custom taget
add_dependencies(RPI_Version
    RPI_Version_Info_Target
)

# cannot link RPI_Version directly to a add_custom_target
add_custom_target(RPI_Version_Info_Target
    COMMAND ${CMAKE_COMMAND}
        -DCMAKE_MODULE_PATH=${CMAKE_MODULE_PATH} # make sure to set cmake path for including
        -DVERSION_SRC_PATH=${VERSION_SRC_PATH} # VERSION_SRC_PATH used in script for copying
        -DVERSION_DST_PATH=${VERSION_DST_PATH} # VERSION_DST_PATH used in script for copying
        -P ${CMAKE_CURRENT_SOURCE_DIR}/config_version.cmake # need to execute script each build
)
